{% extends 'admin/master.html' %}

{% macro highlight_email(email, query, is_regex) -%}
  {% if is_regex %}
    <mark>{{ email }}</mark>
  {% else %}
    {{ email }}
  {% endif %}
{%- endmacro %}

{% macro show_user(user) -%}
  <h4>User {{ user.email }} with ID {{ user.id }}.</h4>
  {% set pu = helper.partner_user(user) %}
  <table class="table">
    <thead>
      <tr>
        <th scope="col">User ID</th>
        <th scope="col">Email</th>
        <th scope="col">Verified</th>
        <th scope="col">Status</th>
        <th scope="col">Pending deletion</th>
        <th scope="col">Paid</th>
        <th scope="col">Premium</th>
        <th>Subscription</th>
        <th>Created At</th>
        <th>Updated At</th>
        <th>Connected with Proton account</th>
        {% if user.delete_on %}
          <th>Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ user.id }}</td>
        <td>
          <a href="?query={{ user.email }}&search_type=email">{{ user.email }}</a>
        </td>
        {% if user.activated %}

          <td class="text-success">Activated</td>
        {% else %}
          <td class="text-warning">Pending</td>
        {% endif %}
        {% if user.disabled %}

          <td class="text-danger">Disabled</td>
        {% else %}
          <td class="text-success">Enabled</td>
        {% endif %}
        {% if user.delete_on %}

          <td class="text-danger">{{ user.delete_on }}</td>
        {% else %}
          <td class="text-success">None</td>
        {% endif %}
        <td>{{ "yes" if user.is_paid() else "No" }}</td>
        <td>{{ "yes" if user.is_premium() else "No" }}</td>
        <td>{{ user.get_active_subscription() }}</td>
        <td>{{ user.created_at }}</td>
        <td>{{ user.updated_at }}</td>
        {% if pu %}

          <td class="flex">
            <a href="?query={{ pu.partner_email }}&search_type=email">{{ pu.partner_email }}</a>
            <form class="d-inline"
                  action="{{ url_for("admin.email_search.delete_partner_link") }}"
                  method="POST">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <button type="submit"
                      onclick="return confirm('Are you sure you would like to unlink the user?');"
                      class="btn btn-danger d-inline">Unlink</button>
            </form>
          </td>
        {% else %}
          <td>No</td>
        {% endif %}
        {% if user.delete_on %}
          <td>
            <form class="d-inline"
                  action="{{ url_for("admin.email_search.stop_user_deletion") }}"
                  method="POST">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <button type="submit"
                      onclick="return confirm('Are you sure you want to cancel the scheduled deletion for this user?');"
                      class="btn btn-warning btn-sm">Stop Deletion</button>
            </form>
          </td>
        {% endif %}
      </tr>
    </tbody>
  </table>
  {{ show_quotas(user) }}
{%- endmacro %}
{% macro show_quotas(user) -%}
  <div class="border border-secondary mt-3 mb-3 p-3">
    <h5>Quotas</h5>
    <div class="mb-3">
      <label for="subdomain_quota_{{ user.id }}" class="form-label">
        <strong>Subdomain quota</strong>
        <small class="text-muted">(Current: {{ user._subdomain_quota }})</small>
      </label>
      <form action="{{ url_for("admin.email_search.update_subdomain_quota") }}" method="POST">
        <input type="hidden" name="user_id" value="{{ user.id }}">
        <div class="input-group" style="max-width: 300px;">
          <input type="number"
                 id="subdomain_quota_{{ user.id }}"
                 name="subdomain_quota"
                 value="{{ user._subdomain_quota }}"
                 class="form-control"
                 min="0"
                 max="1000">
          <button type="submit"
                  onclick="return confirm('Are you sure you want to update the subdomain quota for this user?');"
                  class="btn btn-outline-primary">
            <i class="fa fa-save"></i> Update
          </button>
        </div>
      </form>
    </div>
    <div class="mb-3">
      <label for="directory_quota_{{ user.id }}" class="form-label">
        <strong>Directory quota</strong>
        <small class="text-muted">(Current: {{ user._directory_quota }})</small>
      </label>
      <form action="{{ url_for("admin.email_search.update_directory_quota") }}" method="POST">
        <input type="hidden" name="user_id" value="{{ user.id }}">
        <div class="input-group" style="max-width: 300px;">
          <input type="number"
                 id="directory_quota_{{ user.id }}"
                 name="directory_quota"
                 value="{{ user._directory_quota }}"
                 class="form-control"
                 min="0"
                 max="1000">
          <button type="submit"
                  onclick="return confirm('Are you sure you want to update the directory quota for this user?');"
                  class="btn btn-outline-primary">
            <i class="fa fa-save"></i> Update
          </button>
        </div>
      </form>
    </div>
  </div>
{%- endmacro %}
{% macro list_mailboxes(message, mbox_count, mboxes, is_regex) %}
  <h4>
    {{ mbox_count }} {{ message }}.
    {% if mbox_count>10 %}Showing only the last 10.{% endif %}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th>Mailbox ID</th>
        <th>Email</th>
        <th>Verified</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody>
      {% for mailbox in mboxes %}

        <tr>
          <td>{{ mailbox.id }}</td>
          <td>
            <a href="?query={{ mailbox.email }}&search_type=email">
              {{ highlight_email(mailbox.email, query, is_regex) }}
            </a>
          </td>
          <td>{{ "Yes" if mailbox.verified else "No" }}</td>
          <td>{{ mailbox.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro list_aliases(alias_count, aliases, is_regex) %}
  <h4>
    {{ alias_count }} Aliases found.
    {% if alias_count>10 %}Showing only the last 10.{% endif %}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th>Alias ID</th>
        <th>Email</th>
        <th>Enabled</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody>
      {% for alias in aliases %}

        <tr>
          <td>{{ alias.id }}</td>
          <td>
            <a href="?query={{ alias.email }}&search_type=alias">
              {{ highlight_email(alias.email, query, is_regex) }}
            </a>
          </td>
          <td>{{ "Yes" if alias.enabled else "No" }}</td>
          <td>{{ alias.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro show_deleted_alias(deleted_alias, is_regex) -%}
  <h4>
    Deleted Alias {{ highlight_email(deleted_alias.email, query, is_regex) }} with ID {{ deleted_alias.id }}.
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th scope="col">Deleted Alias ID</th>
        <th scope="col">Email</th>
        <th scope="col">Deleted At</th>
        <th scope="col">Reason</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ deleted_alias.id }}</td>
        <td>{{ highlight_email(deleted_alias.email, query, is_regex) }}</td>
        <td>{{ deleted_alias.created_at }}</td>
        <td>{{ deleted_alias.reason }}</td>
      </tr>
    </tbody>
  </table>
{%- endmacro %}
{% macro list_deleted_aliases(deleted_aliases, is_regex) %}
  <h4>
    {{ deleted_aliases|length }} Deleted Aliases found.
    {% if deleted_aliases|length > 10 %}Showing only the last 10.{% endif %}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th scope="col">Deleted Alias ID</th>
        <th scope="col">Email</th>
        <th scope="col">Deleted At</th>
        <th scope="col">Reason</th>
      </tr>
    </thead>
    <tbody>
      {% for deleted_alias in deleted_aliases %}
        <tr>
          <td>{{ deleted_alias.id }}</td>
          <td>{{ highlight_email(deleted_alias.email, query, is_regex) }}</td>
          <td>{{ deleted_alias.created_at }}</td>
          <td>{{ deleted_alias.reason }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro show_domain_deleted_alias(dom_deleted_alias, is_regex) -%}
  <h4>
    Domain Deleted Alias {{ highlight_email(dom_deleted_alias.email, query, is_regex) }} with ID {{ dom_deleted_alias.id }} for
    domain {{ dom_deleted_alias.domain.domain }}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th scope="col">Deleted Alias ID</th>
        <th scope="col">Email</th>
        <th scope="col">Domain</th>
        <th scope="col">Domain ID</th>
        <th scope="col">Domain owner user ID</th>
        <th scope="col">Domain owner user email</th>
        <th scope="col">Deleted At</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ dom_deleted_alias.id }}</td>
        <td>{{ highlight_email(dom_deleted_alias.email, query, is_regex) }}</td>
        <td>{{ dom_deleted_alias.domain.domain }}</td>
        <td>{{ dom_deleted_alias.domain.id }}</td>
        <td>{{ dom_deleted_alias.domain.user_id }}</td>
        <td>{{ dom_deleted_alias.created_at }}</td>
      </tr>
    </tbody>
  </table>
  {{ show_user(dom_deleted_alias.domain.user) }}
{%- endmacro %}
{% macro list_domain_deleted_aliases(domain_deleted_aliases, is_regex) %}
  <h4>
    {{ domain_deleted_aliases|length }} Domain Deleted Aliases found.
    {% if domain_deleted_aliases|length > 10 %}Showing only the last 10.{% endif %}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th scope="col">Deleted Alias ID</th>
        <th scope="col">Email</th>
        <th scope="col">Domain</th>
        <th scope="col">Domain ID</th>
        <th scope="col">Domain owner user ID</th>
        <th scope="col">Deleted At</th>
      </tr>
    </thead>
    <tbody>
      {% for dom_deleted_alias in domain_deleted_aliases %}
        <tr>
          <td>{{ dom_deleted_alias.id }}</td>
          <td>{{ highlight_email(dom_deleted_alias.email, query, is_regex) }}</td>
          <td>{{ dom_deleted_alias.domain.domain }}</td>
          <td>{{ dom_deleted_alias.domain.id }}</td>
          <td>{{ dom_deleted_alias.domain.user_id }}</td>
          <td>{{ dom_deleted_alias.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro list_alias_audit_log(alias_audit_log) %}
  <h4>Alias Audit Log</h4>
  <table class="table">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Alias ID</th>
        <th>Alias Email</th>
        <th>Action</th>
        <th>Message</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in alias_audit_log %}

        <tr>
          <td>{{ entry.user_id }}</td>
          <td>{{ entry.alias_id }}</td>
          <td>
            <a href="?query={{ entry.alias_email }}&search_type=alias">{{ entry.alias_email }}</a>
          </td>
          <td>{{ entry.action }}</td>
          <td>{{ entry.message }}</td>
          <td>{{ entry.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro list_user_audit_log(user_audit_log) %}
  <h4>User Audit Log</h4>
  <table class="table">
    <thead>
      <tr>
        <th>User email</th>
        <th>Action</th>
        <th>Message</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in user_audit_log %}

        <tr>
          <td>
            <a href="?query={{ entry.user_email }}&search_type=email">{{ entry.user_email }}</a>
          </td>
          <td>{{ entry.action }}</td>
          <td>{{ entry.message }}</td>
          <td>{{ entry.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro list_users(users, is_regex) %}
  <h4>
    {{ users|length }} Users found.
    {% if users|length > 10 %}Showing only the last 10.{% endif %}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Email</th>
        <th>Verified</th>
        <th>Status</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
        <tr>
          <td>{{ user.id }}</td>
          <td>
            <a href="?query={{ user.email }}&search_type=email">
              {{ highlight_email(user.email, query, is_regex) }}
            </a>
          </td>
          <td>{{ "Yes" if user.activated else "No" }}</td>
          <td>{{ "Disabled" if user.disabled else "Enabled" }}</td>
          <td>{{ user.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% macro list_partner_users(partner_users, is_regex) %}
  <h4>
    {{ partner_users|length }} Partner Users found.
    {% if partner_users|length > 10 %}Showing only the last 10.{% endif %}
    {% if is_regex %}<span class="badge bg-info">Found by regex</span>{% endif %}
  </h4>
  <table class="table">
    <thead>
      <tr>
        <th>Partner User ID</th>
        <th>Partner Email</th>
        <th>User ID</th>
        <th>User Email</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody>
      {% for pu in partner_users %}
        <tr>
          <td>{{ pu.id }}</td>
          <td>{{ highlight_email(pu.partner_email, query, is_regex) }}</td>
          <td>{{ pu.user.id }}</td>
          <td>
            <a href="?query={{ pu.user.email }}&search_type=email">{{ pu.user.email }}</a>
          </td>
          <td>{{ pu.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
{% block body %}

  <div class="border border-dark border-2 mt-1 mb-2 p-3">
    <form method="get">
      <div class="form-group mb-3">
        <label class="form-label"><strong>Search type:</strong></label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="search_type" id="search_type_email" value="email" {{ 'checked' if search_type == 'email' else '' }}>
          <label class="form-check-label" for="search_type_email">Email (Mailboxes, Users, Partner Users)</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="search_type" id="search_type_alias" value="alias" {{ 'checked' if search_type == 'alias' else '' }}>
          <label class="form-check-label" for="search_type_alias">Alias (Aliases, Deleted Aliases)</label>
        </div>
      </div>
      <div class="form-group">
        <label for="query">Query (exact email, user ID, or POSIX regex pattern):</label>
        <input type="text"
               class="form-control"
               name="query"
               id="query"
               value="{{ query or '' }}"
               placeholder="e.g., user@example.com or .*@example\.com" />
        <small class="form-text text-muted">
          First searches for exact match. If not found, uses POSIX regex (limited to 10 results).
        </small>
      </div>
      <button type="submit" class="btn btn-primary mt-2">Submit</button>
    </form>
  </div>

  {% if data.no_match and query %}
    <div class="border border-dark border-2 mt-1 mb-2 p-3 alert alert-warning"
         role="alert">
      No results found for "{{ query }}" in {{ 'aliases' if search_type == 'alias' else 'emails' }}
    </div>
  {% endif %}

  {# Alias search results #}
  {% if search_type == 'alias' %}

    {% if data.aliases %}
      <div class="border border-dark border-2 mt-1 mb-2 p-3">
        <h3 class="mb-3">
          {% if data.aliases_found_by_regex %}
            Found {{ data.aliases|length }} Aliases matching regex "{{ query }}"
          {% else %}
            Found Alias {{ data.aliases[0].email }}
          {% endif %}
        </h3>
        {{ list_aliases(data.aliases|length, data.aliases, data.aliases_found_by_regex) }}
        {% if data.alias_audit_log %}
          {{ list_alias_audit_log(data.alias_audit_log) }}
        {% endif %}
        {% if not data.aliases_found_by_regex and data.aliases|length == 1 %}
          {{ list_mailboxes("Mailboxes for alias", helper.alias_mailbox_count(data.aliases[0]), helper.alias_mailboxes(data.aliases[0]), false) }}
          {{ show_user(data.aliases[0].user) }}
        {% endif %}
      </div>
    {% endif %}

    {% if data.deleted_aliases %}
      <div class="border border-dark mt-1 mb-2 p-3">
        <h3 class="mb-3">
          {% if data.deleted_aliases_found_by_regex %}
            Found {{ data.deleted_aliases|length }} Deleted Aliases matching regex "{{ query }}"
          {% else %}
            Found Deleted Alias {{ data.deleted_aliases[0].email }}
          {% endif %}
        </h3>
        {{ list_deleted_aliases(data.deleted_aliases, data.deleted_aliases_found_by_regex) }}
        {% if data.deleted_alias_audit_log %}
          {{ list_alias_audit_log(data.deleted_alias_audit_log) }}
        {% endif %}
      </div>
    {% endif %}

    {% if data.domain_deleted_aliases %}
      <div class="border border-dark mt-1 mb-2 p-3">
        <h3 class="mb-3">
          {% if data.domain_deleted_aliases_found_by_regex %}
            Found {{ data.domain_deleted_aliases|length }} Domain Deleted Aliases matching regex "{{ query }}"
          {% else %}
            Found Domain Deleted Alias {{ data.domain_deleted_aliases[0].email }}
          {% endif %}
        </h3>
        {% if data.domain_deleted_aliases_found_by_regex %}
          {{ list_domain_deleted_aliases(data.domain_deleted_aliases, data.domain_deleted_aliases_found_by_regex) }}
        {% else %}
          {{ show_domain_deleted_alias(data.domain_deleted_aliases[0], data.domain_deleted_aliases_found_by_regex) }}
          {% if data.domain_deleted_alias_audit_log %}
            {{ list_alias_audit_log(data.domain_deleted_alias_audit_log) }}
          {% endif %}
        {% endif %}
      </div>
    {% endif %}

  {% else %}
    {# Email search results #}

    {% if data.users %}
      <div class="border border-dark border-2 mt-1 mb-2 p-3">
        <h3 class="mb-3">
          {% if data.users_found_by_regex %}
            Found {{ data.users|length }} Users matching regex "{{ query }}"
          {% else %}
            Found User {{ data.users[0].email }}
          {% endif %}
        </h3>
        {% if data.users_found_by_regex %}
          {{ list_users(data.users, data.users_found_by_regex) }}
        {% else %}
          {{ show_user(data.users[0]) }}
          {{ list_mailboxes("Mailboxes for user", helper.mailbox_count(data.users[0]), helper.mailbox_list(data.users[0]), false) }}
          {{ list_aliases(helper.alias_count(data.users[0]), helper.alias_list(data.users[0]), false) }}
        {% endif %}
      </div>
    {% endif %}

    {% if data.user_audit_log and not data.users %}
      <div class="border border-dark border-2 mt-1 mb-2 p-3">
        <h3 class="mb-3">Audit log entries for user {{ data.query }}</h3>
        {{ list_user_audit_log(data.user_audit_log) }}
      </div>
    {% endif %}

    {% if data.mailboxes %}
      <div class="border border-dark border-2 mt-1 mb-2 p-3">
        <h3 class="mb-3">
          {% if data.mailboxes_found_by_regex %}
            Found {{ data.mailbox_count }} Mailboxes matching regex "{{ query }}"
          {% else %}
            Found {{ data.mailbox_count }} Mailbox(es) for {{ query }}
          {% endif %}
        </h3>
        {{ list_mailboxes("Mailboxes found", data.mailbox_count, data.mailboxes, data.mailboxes_found_by_regex) }}
        {% if not data.mailboxes_found_by_regex %}
          {% for mailbox in data.mailboxes %}
            <div class="border border-secondary mt-2 mb-2 p-2">
              <h5>Owner of mailbox {{ mailbox.email }}</h5>
              {{ show_user(mailbox.user) }}
            </div>
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}

    {% if data.partner_users %}
      <div class="border border-dark border-2 mt-1 mb-2 p-3">
        <h3 class="mb-3">
          {% if data.partner_users_found_by_regex %}
            Found {{ data.partner_users|length }} Partner Users matching regex "{{ query }}"
          {% else %}
            Found Partner User with email {{ data.partner_users[0].partner_email }}
          {% endif %}
        </h3>
        {{ list_partner_users(data.partner_users, data.partner_users_found_by_regex) }}
        {% if not data.partner_users_found_by_regex and data.partner_users|length == 1 %}
          <div class="border border-secondary mt-2 mb-2 p-2">
            <h5>Associated User</h5>
            {{ show_user(data.partner_users[0].user) }}
          </div>
        {% endif %}
      </div>
    {% endif %}

  {% endif %}

{% endblock %}
